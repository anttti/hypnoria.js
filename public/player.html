<!doctype html>
<html>
  <head>
  </head>
  <body>
    <button class="mute">Mute</button>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      var oscillator = audioCtx.createOscillator();
      var amp = audioCtx.createGain();
      var filter = audioCtx.createBiquadFilter();

      oscillator.connect(filter);
      filter.connect(amp);
      amp.connect(audioCtx.destination);

      filter.type = 'lowpass';
      filter.frequency.value = 750;

      oscillator.type = 'sawtooth';
      oscillator.frequency.value = 500;
      oscillator.start();

      amp.gain.value = 0.5;

      var oscFreqMin = 100;
      var oscFreqMax = 1000;
      var filterFreqMin = 0;
      var filterFreqMax = 10000;

      var clamp = function(val, min, max) {
        if (val < min) return min;
        if (val > max) return max;
        return val;
      }

      var mute = document.querySelector('.mute');
      mute.onclick = function() {
        if (mute.id === '') {
          amp.disconnect(audioCtx.destination);
          mute.id = 'activated';
          mute.innerHTML = 'Unmute';
        } else {
          amp.connect(audioCtx.destination);
          mute.id = '';
          mute.innerHTML = 'Mute';
        }
      }

      var socket = io();
      socket.on('sound-play', function(payload) {
        var parsed = JSON.parse(payload);
        var now = new Date().getTime();
        var latency = now - parsed.timestamp;

        var newOscFreq = clamp(parsed.param1, oscFreqMin, oscFreqMax);
        var newFilterFreq = clamp(parsed.param2, filterFreqMin, filterFreqMax);
        console.log('oscfreq:', newOscFreq, 'filterfreq:', newFilterFreq);
        
        oscillator.frequency.value = newOscFreq;
        filter.frequency.value = newFilterFreq;
      });
    </script>
  </body>
</html>